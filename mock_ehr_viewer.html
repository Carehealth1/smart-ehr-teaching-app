<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mock EHR Viewer (FHIR-ready)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 24px; margin-bottom: 10px; }
    select { font-size: 16px; padding: 4px; }
    .patient-info { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    .section { margin-top: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color: #666; }
    .nav { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .nav button { padding: 6px 10px; }
  </style>
</head>
<body>
  <h1>Mock EHR Viewer (FHIR-compatible)</h1>
  <p class="muted">Loads JSON from your GitHub Pages URL, so it works from SMART Launcher.</p>

  <label for="patient-select">Select a patient:</label>
  <select id="patient-select"></select>

  <div class="nav">
    <button data-tab="demographics">Demographics</button>
    <button data-tab="insurance">Insurance</button>
    <button data-tab="vitals">Vitals</button>
    <button data-tab="meds">Medications</button>
    <button data-tab="allergies">Allergies</button>
    <button data-tab="labs">Labs</button>
    <button data-tab="imaging">Imaging</button>
    <button data-tab="visits">Clinic Visits</button>
    <button data-tab="hospital">Hospitalizations</button>
    <button data-tab="claims">Claims</button>
  </div>

  <div class="patient-info" id="patient-info"></div>

  <script>
    // IMPORTANT: After you upload these files to your repo root, this URL will be valid.
    // If you ever change the repo/user name, update this constant.
    const DATA_URL = 'https://carehealth1.github.io/smart-ehr-teaching-app/mock_ehr_prototype.json';

    let EHR = null, CURRENT = null, TAB = 'demographics';

    async function loadData() {
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Could not load mock_ehr_prototype.json at ' + DATA_URL);
      EHR = await res.json();

      const dd = document.getElementById('patient-select');
      dd.innerHTML = '';
      EHR.patients.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p.name[0].given.join(' ') + ' ' + p.name[0].family;
        dd.appendChild(opt);
      });
      dd.addEventListener('change', e => { CURRENT = EHR.patients[+e.target.value]; render(); });

      CURRENT = EHR.patients[0];
      dd.value = '0';
      render();
    }

    function setTab(n) { TAB = n; render(); }

    function render() {
      const el = document.getElementById('patient-info');
      if (!CURRENT) { el.innerHTML = '<p>Pick a patient.</p>'; return; }
      const cov = CURRENT.insurance || {};
      const vitals = CURRENT.vitals || [];
      const meds = CURRENT.medications || [];
      const allergies = CURRENT.allergies || [];
      const labs = CURRENT.labs || [];
      const imaging = CURRENT.imaging || [];
      const visits = CURRENT.clinic_visits || [];
      const hospital = CURRENT.hospitalizations || [];
      const claims = (cov && cov.claims_history) ? cov.claims_history : [];

      const views = {
        demographics: `
          <div class="section">
            <h2>Demographics</h2>
            <div class="row">
              <div><strong>Name:</strong> ${CURRENT.name[0].given.join(' ')} ${CURRENT.name[0].family}</div>
              <div><strong>Gender:</strong> ${CURRENT.gender}</div>
              <div><strong>DOB:</strong> ${CURRENT.birthDate}</div>
              <div><strong>MRN:</strong> ${CURRENT.identifier?.[0]?.value || '—'}</div>
            </div>
          </div>`,
        insurance: `
          <div class="section">
            <h2>Insurance</h2>
            ${cov.provider ? `
              <div class="row">
                <div><strong>Provider:</strong> ${cov.provider}</div>
                <div><strong>Plan Type:</strong> ${cov.plan_type}</div>
                <div><strong>Policy #:</strong> ${cov.policy_number}</div>
                <div><strong>Model:</strong> ${cov.reimbursement_model || '—'}</div>
                <div><strong>Deductible:</strong> $${cov.coverage?.deductible ?? '0'}</div>
                <div><strong>Copay:</strong> $${cov.coverage?.copay ?? '0'}</div>
                <div><strong>Coinsurance:</strong> ${(cov.coverage?.coinsurance ?? 0)*100}%</div>
                <div><strong>OOP Max:</strong> $${cov.coverage?.out_of_pocket_max ?? '0'}</div>
              </div>` : '<p>No insurance on file.</p>'}
          </div>`,
        vitals: `
          <div class="section"><h2>Vitals</h2>
            ${vitals.length ? vitals.map(v => `
              <div class="row">
                <div><strong>${v.code.display}:</strong> ${v.value} ${v.unit}</div>
                <div><strong>Taken:</strong> ${v.effectiveDateTime}</div>
              </div>`).join('') : '<p>No vitals recorded.</p>'}
          </div>`,
        meds: `
          <div class="section"><h2>Medications</h2>
            ${meds.length ? meds.map(m => `
              <div class="row">
                <div><strong>${m.medicationCodeableConcept?.text || m.drug}</strong></div>
                <div><strong>Sig:</strong> ${m.dosage || '—'}</div>
                <div><strong>Status:</strong> ${m.status || 'active'}</div>
              </div>`).join('') : '<p>No medications on file.</p>'}
          </div>`,
        allergies: `
          <div class="section"><h2>Allergies</h2>
            ${allergies.length ? allergies.map(a => `
              <div class="row">
                <div><strong>Substance:</strong> ${a.substance}</div>
                <div><strong>Reaction:</strong> ${a.reaction || '—'}</div>
                <div><strong>Severity:</strong> ${a.severity || '—'}</div>
              </div>`).join('') : '<p>No allergies documented.</p>'}
          </div>`,
        labs: `
          <div class="section"><h2>Labs</h2>
            ${labs.length ? labs.map(l => `
              <div class="row">
                <div><strong>${l.code.display}</strong></div>
                <div><strong>Result:</strong> ${l.value} ${l.unit}</div>
                <div><strong>Date:</strong> ${l.effectiveDateTime}</div>
              </div>`).join('') : '<p>No labs available.</p>'}
          </div>`,
        imaging: `
          <div class="section"><h2>Imaging</h2>
            ${imaging.length ? imaging.map(i => `
              <div class="row">
                <div><strong>${i.modality}</strong></div>
                <div><strong>Body Site:</strong> ${i.bodySite || '—'}</div>
                <div><strong>Date:</strong> ${i.effectiveDateTime}</div>
                <div><strong>Impression:</strong> ${i.impression || '—'}</div>
              </div>`).join('') : '<p>No imaging studies.</p>'}
          </div>`,
        visits: `
          <div class="section"><h2>Clinic Visits</h2>
            ${visits.length ? visits.map(v => `
              <div class="row">
                <div><strong>Date:</strong> ${v.period?.start || v.date}</div>
                <div><strong>Type:</strong> ${v.type || 'Office Visit'}</div>
                <div><strong>CPT:</strong> ${v.cpt || '—'}</div>
                <div><strong>Notes:</strong> ${v.note || '—'}</div>
              </div>`).join('') : '<p>No clinic visits recorded.</p>'}
          </div>`,
        hospital: `
          <div class="section"><h2>Hospitalizations</h2>
            ${hospital.length ? hospital.map(h => `
              <div class="row">
                <div><strong>Admit:</strong> ${h.period?.start}</div>
                <div><strong>Discharge:</strong> ${h.period?.end || '—'}</div>
                <div><strong>DRG:</strong> ${h.drg || '—'}</div>
                <div><strong>Disposition:</strong> ${h.disposition || '—'}</div>
              </div>`).join('') : '<p>No hospital events.</p>'}
          </div>`,
        claims: `
          <div class="section"><h2>Claims / EOB Summary</h2>
            ${claims.length ? claims.map(c => `
              <div class="row">
                <div><strong>Service:</strong> ${c.service}</div>
                <div><strong>Date:</strong> ${c.date}</div>
                <div><strong>Charge:</strong> $${c.cost}</div>
                <div><strong>Approved:</strong> $${c.approved_amount}</div>
                <div><strong>Status:</strong> ${c.status}</div>
                ${c.reason ? `<div><strong>Reason:</strong> ${c.reason}</div>` : ''}
              </div>`).join('') : '<p>No claims on file.</p>'}
          </div>`
      };

      el.innerHTML = views[TAB] || views.demographics;
    }

    document.querySelectorAll('.nav button').forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab)));
    loadData().catch(err => {
      document.getElementById('patient-info').innerHTML = '<p style="color:red;">' + err.message + '</p>';
    });
  </script>
</body>
</html>
